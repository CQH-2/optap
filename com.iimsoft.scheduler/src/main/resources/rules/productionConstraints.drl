package com.iimsoft.scheduler.rules
dialect "java"

import com.iimsoft.scheduler.domain.TaskPart
import com.iimsoft.scheduler.domain.Router
import com.iimsoft.scheduler.domain.Line
import com.iimsoft.scheduler.domain.LineShiftSlot
import org.optaplanner.core.api.score.buildin.hardsoft.HardSoftScoreHolder
import java.util.Set

global HardSoftScoreHolder scoreHolder

// 硬约束：选定槽位的产线必须支持所选工艺
rule "Line must support router"
when
    TaskPart(slot != null, router != null, $slot : slot, $router : router, eval(!$slot.getLine().supports($router)))
then
    scoreHolder.addHardConstraintMatch(kcontext, -1);
end

// 硬约束：工艺必须支持该物料
rule "Router must support item"
when
    TaskPart(router != null, $router : router, $item : item, eval(!$router.supports($item)))
then
    scoreHolder.addHardConstraintMatch(kcontext, -1);
end

// 硬约束：槽位产能不能超
rule "Slot capacity must not be exceeded"
when
    $slot : LineShiftSlot()
    $sum : Number() from accumulate(
        TaskPart(slot == $slot, $q : quantity),
        sum($q)
    )
    eval($sum.intValue() > $slot.getCapacityUnits())
then
    int over = $sum.intValue() - $slot.getCapacityUnits();
    scoreHolder.addHardConstraintMatch(kcontext, -over);
end

// 新增硬约束：同一槽位内禁止混工艺（一个槽位只能跑一种 Router）
// 若发现同一槽位内存在多个不同 Router，则按超出1种的数量进行硬罚
rule "Single router per slot (no mixing within a slot)"
when
    $slot : LineShiftSlot()
    $routerSet : Set() from accumulate(
        TaskPart(slot == $slot, router != null, $r : router),
        collectSet($r)
    )
    eval($routerSet.size() > 1)
then
    int overKinds = $routerSet.size() - 1;
    scoreHolder.addHardConstraintMatch(kcontext, -overKinds);
end

// 软约束：越早的槽位越优（全局尽量提前完工）
rule "Prefer earlier slot (by end time)"
when
    TaskPart(slot != null, $end : slot.endIndex)
then
    scoreHolder.addSoftConstraintMatch(kcontext, - (int)$end);
end

// 软约束：交期迟期惩罚（从 TaskPart.task 读取交期）
rule "Minimize tardiness (due date)"
when
    TaskPart(slot != null, $end : slot.endIndex, $due : task.dueEndIndexMinutes)
    eval($due != null && $end > $due.longValue())
then
    int late = (int)($end - $due.longValue());
    scoreHolder.addSoftConstraintMatch(kcontext, -late);
end

// 软约束：同一条产线的负载尽量均衡（平方惩罚）
rule "Balance line load"
when
    $line : Line()
    $sum : Number() from accumulate(
        TaskPart(slot != null, $line == getLine(), $q : quantity),
        sum($q)
    )
then
    int load = $sum.intValue();
    scoreHolder.addSoftConstraintMatch(kcontext, -(load * load));
end